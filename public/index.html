<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PanaderÃ­a La Desesperanza ğŸ…ğŸ„</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #fff8f0, #ffe5d9);
      font-family: 'Segoe UI', sans-serif;
    }
    h1 {
      font-family: 'Georgia', serif;
      font-weight: bold;
      color: #b22222;
      text-shadow: 2px 2px #006400;
    }
    p {
      color: #444;
      font-style: italic;
    }
    /* Login card */
    #auth form {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    #auth .btn-primary {
      background-color: #b22222;
      border: none;
    }
    #auth .btn-primary:hover {
      background-color: #8b0000;
    }
    #auth .btn-secondary {
      background-color: #006400;
      border: none;
    }
    #auth .btn-secondary:hover {
      background-color: #228b22;
    }
    /* Pan form */
    #panForm {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    #panForm .btn-success {
      background-color: #006400;
      border: none;
    }
    #panForm .btn-success:hover {
      background-color: #228b22;
    }
    /* Carrito */
    #carritoSeccion {
      border: 2px solid #b22222;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    #carritoSeccion .card-header {
      background-color: #b22222;
      color: #fff;
      font-weight: bold;
    }
    #carritoSeccion .btn-success {
      background-color: #006400;
      border: none;
    }
    #carritoSeccion .btn-success:hover {
      background-color: #228b22;
    }
    /* Botones inferiores */
    #mostrarCarritoBtn {
      border-color: #b22222;
      color: #b22222;
    }
    #mostrarCarritoBtn:hover {
      background-color: #b22222;
      color: #fff;
    }
    #logoutBtn {
      border-color: #006400;
      color: #006400;
    }
    #logoutBtn:hover {
      background-color: #006400;
      color: #fff;
    }
    /* Pan cards */
    .pan-card {
      border: 2px solid #d2691e;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }
    .pan-card:hover {
      transform: scale(1.05);
    }
    .pan-card img {
      height: 150px;
      object-fit: cover;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    /* Map */
    #map {
      height: 400px;
      width: 100%;
      border: 3px solid #b22222;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    /* Ocultar secciones iniciales */
    #carritoSeccion { display: none; }
    #panaderia, #logoutBtn { display: none; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="text-center">ğŸ„ PanaderÃ­a La Desesperanza ğŸ…</h1>
    <p class="text-center">âœ¨ Temporada navideÃ±a: hora de disfrutar pan de muerto y rosca de reyes ğŸâœ¨</p>

    <!-- Login -->
    <div id="auth" class="mb-4">
      <form id="loginForm" class="row g-3" autocomplete="off">
        <div class="col-md-3">
          <input type="text" id="nombre" class="form-control" placeholder="Nombre completo" required
            pattern="^[a-zA-ZÃÃ‰ÃÃ“ÃšÃ¡Ã©Ã­Ã³ÃºÃ±Ã‘\s]{2,50}$"
            title="Solo letras y espacios, mÃ­nimo 2 caracteres">
        </div>
        <div class="col-md-3">
          <input type="email" id="correo" class="form-control" placeholder="Correo electrÃ³nico" required>
        </div>
        <div class="col-md-3">
          <input type="password" id="contraseÃ±a" class="form-control" placeholder="ContraseÃ±a" required
            minlength="6" maxlength="50"
            title="MÃ­nimo 6 caracteres">
        </div>
        <div class="col-md-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary">ğŸ Iniciar sesiÃ³n</button>
          <button type="button" id="registroBtn" class="btn btn-secondary">ğŸ„ Registrarse</button>
        </div>
      </form>
    </div>

    <!-- PanaderÃ­a -->
    <div id="panaderia">
      <form id="panForm" class="row g-3 mb-4">
        <input type="hidden" id="panId">
        <input type="hidden" id="imagenBase64">
        <div class="col-md-4">
          <input type="text" id="nombrePan" class="form-control" placeholder="Nombre del pan" required>
        </div>
        <div class="col-md-4">
          <input type="text" id="descripcion" class="form-control" placeholder="DescripciÃ³n">
        </div>
        <div class="col-md-2">
          <input type="number" id="precio" class="form-control" placeholder="Precio" required>
        </div>
        <div class="col-md-2">
          <input type="file" id="imagenFile" class="form-control" accept="image/*" required>
        </div>
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-success">ğŸ… Guardar</button>
        </div>
      </form>

      <div id="galeria" class="row"></div>

      <div id="carritoSeccion" class="card mt-5">
        <div class="card-header">ğŸ›’ Carrito NavideÃ±o ğŸ</div>
        <div class="card-body">
          <table class="table table-bordered" id="tablaCarrito">
            <thead class="table-danger">
              <tr>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Total</th>
                <th>AcciÃ³n</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <h4 class="text-end text-success fw-bold" id="totalCarrito">Total: $0.00</h4>
          <div class="text-end mt-3">
            <button id="pagarCarritoBtn" class="btn btn-success">ğŸ’¸ Pagar carrito</button>
          </div>
        </div>
      </div>

      <div class="text-end mt-3">
        <button id="mostrarCarritoBtn" class="btn btn-outline-primary">ğŸ›’ Ver carrito</button>
        <button id="logoutBtn" class="btn btn-outline-danger">âŒ Cerrar sesiÃ³n</button>
      </div>

      <div class="mt-4 text-center">
        <h4 class="text-primary">ğŸ„ VisÃ­tanos en estas fiestas ğŸ…</h4>
        <div id="map" style="margin-top:20px; display:none;"></div>
      </div>
    </div>
  </div>

  <script>
    let esAdmin = false;

    const form = document.getElementById('panForm');
    const galeria = document.getElementById('galeria');
    const imagenFile = document.getElementById('imagenFile');
    const imagenBase64 = document.getElementById('imagenBase64');

    imagenFile.addEventListener('change', () => {
      const file = imagenFile.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onloadend = () => {
          const base64 = reader.result.split(',')[1];
          imagenBase64.value = base64;
        };
        reader.readAsDataURL(file);
      }
    });

    form.addEventListener('submit', async e => {
      e.preventDefault();
      const nombre = document.getElementById('nombrePan').value.trim();
      const precio = parseFloat(document.getElementById('precio').value);
      const imagen = imagenBase64.value;
      if (!nombre || isNaN(precio) || !imagen) {
        alert('Nombre, precio e imagen son obligatorios');
        return;
      }

      const pan = {
        nombre,
        descripcion: document.getElementById('descripcion').value,
        precio,
        imagen
      };

      const id = document.getElementById('panId').value;
      const method = id ? 'PUT' : 'POST';
      const url = id ? `/inventario/${id}` : '/inventario';

      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(pan)
      });

      if (res.ok) {
        form.reset();
        document.getElementById('panId').value = '';
        imagenBase64.value = '';
        cargarPanes();
      } else {
        const error = await res.json();
        alert(error.error || 'Error en el servidor');
      }
    });

    async function cargarPanes() {
      const res = await fetch('/inventario');
      if (!res.ok) return;
      const panes = await res.json();
      galeria.innerHTML = '';
      panes.forEach(pan => {
        galeria.innerHTML += `
          <div class="col-md-4 mb-3">
            <div class="card pan-card">
              <img src="data:image/jpeg;base64,${pan.imagen}" class="card-img-top" alt="${pan.nombre}">
              <div class="card-body">
                <h5 class="card-title">${pan.nombre}</h5>
                <p class="card-text">${pan.descripcion}</p>
                <p class="text-success">$${pan.precio}</p>
                ${esAdmin ? `
                  <button class="btn btn-warning btn-sm" onclick="editarPan(${pan.id})">Editar</button>
                  <button class="btn btn-danger btn-sm" onclick="eliminarPan(${pan.id})">Eliminar</button>
                ` : ''}
                <button class="btn btn-primary btn-sm" onclick="agregarAlCarrito(${pan.id})">Agregar al carrito</button>
              </div>
            </div>
          </div>
        `;
      });
    }

    async function editarPan(id) {
      const res = await fetch(`/inventario`);
      const panes = await res.json();
      const pan = panes.find(p => p.id === id);
      if (pan) {
        document.getElementById('nombrePan').value = pan.nombre;
        document.getElementById('descripcion').value = pan.descripcion;
        document.getElementById('precio').value = pan.precio;
        document.getElementById('panId').value = pan.id;
        imagenBase64.value = pan.imagen;
      }
    }

    async function eliminarPan(id) {
      if (confirm('Â¿Eliminar este pan?')) {
        await fetch(`/inventario/${id}`, { method: 'DELETE' });
        cargarPanes();
      }
    }

    async function agregarAlCarrito(producto_id) {
      await fetch('/carrito/agregar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ producto_id, cantidad: 1 })
      });
      cargarCarrito();
    }

    async function cargarCarrito() {
      const res = await fetch('/carrito');
      if (!res.ok) return;
      const carrito = await res.json();
      const tbody = document.querySelector('#tablaCarrito tbody');
      tbody.innerHTML = '';

      carrito.forEach(item => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
          <td>${item.nombre}</td>
          <td>$${item.precio}</td>
          <td>${item.cantidad}</td>
          <td>$${(item.precio * item.cantidad).toFixed(2)}</td>
          <td><button class="btn btn-danger btn-sm" onclick="eliminarDelCarrito(${item.id})">Eliminar</button></td>
        `;
        tbody.appendChild(fila);
      });

      const totalRes = await fetch('/carrito/total');
      const { total } = await totalRes.json();
      document.getElementById('totalCarrito').textContent = `Total: $${total.toFixed(2)}`;
    }

    async function eliminarDelCarrito(id) {
      await fetch(`/carrito/${id}`, { method: 'DELETE' });
      cargarCarrito();
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/logout', { method: 'POST' });
      ocultarPanaderia();
    });

    document.getElementById('registroBtn').addEventListener('click', async () => {
      const nombre = document.getElementById('nombre').value;
      const correo = document.getElementById('correo').value;
      const contraseÃ±a = document.getElementById('contraseÃ±a').value;

      if (!nombre || !correo || !contraseÃ±a) {
        alert('Todos los campos son obligatorios');
        return;
      }

      const res = await fetch('/registro', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nombre, correo, contraseÃ±a })
      });

      const data = await res.json();
      if (res.ok) {
        alert(data.mensaje);
      } else {
        alert(data.error || 'Error al registrarse');
      }
    });

    document.getElementById('loginForm').addEventListener('submit', async e => {
      e.preventDefault();
      const correo = document.getElementById('correo').value;
      const contraseÃ±a = document.getElementById('contraseÃ±a').value;

      const res = await fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ correo, contraseÃ±a })
      });

      if (res.ok) {
        const admin = correo === 'admin@panaderia.com' && contraseÃ±a === 'admin123';
        mostrarPanaderia(admin);
      } else {
        const error = await res.json();
        alert(error.error || 'Error al iniciar sesiÃ³n');
      }
    });

function mostrarPanaderia(admin) {
  esAdmin = admin;
  document.getElementById('auth').style.display = 'none';
  document.getElementById('panaderia').style.display = 'block';
  document.getElementById('logoutBtn').style.display = 'inline-block';
  document.getElementById('panForm').style.display = esAdmin ? 'flex' : 'none';

  document.getElementById('mostrarCarritoBtn').style.display = esAdmin ? 'none' : 'inline-block';
  document.getElementById('carritoSeccion').style.display = 'none';

  cargarPanes();

  const mapDiv = document.getElementById('map');
  mapDiv.style.display = 'block';
  initMapa();
  setTimeout(refrescarMapaSiOculto, 100);
}

    document.getElementById('mostrarCarritoBtn').addEventListener('click', () => {
      document.getElementById('carritoSeccion').style.display = 'block';
      cargarCarrito();
    });

    document.getElementById('pagarCarritoBtn').addEventListener('click', async () => {
      if (!confirm('Â¿Confirmas el pago del carrito?')) return;

      const res = await fetch('/carrito/pagar', {
        method: 'PUT',
        credentials: 'include'
      });

      const data = await res.json();
      alert(data.mensaje || data.error || 'Productos pagados :)');
      cargarCarrito();
    });

function ocultarPanaderia() {
  esAdmin = false;
  document.getElementById('auth').style.display = 'block';
  document.getElementById('panaderia').style.display = 'none';
  document.getElementById('logoutBtn').style.display = 'none';
  document.getElementById('map').style.display = 'none';
}

    async function verificarSesion() {
      const res = await fetch('/inventario');
      if (res.ok) {
        mostrarPanaderia(false);
      } else {
        ocultarPanaderia();
      }
    }

  verificarSesion();

  

  let mapInstance = null;

  function initMapa() {
    const mapContainer = document.getElementById('map');
    if (!mapContainer) return;

    if (mapInstance) return;

    const coords = [19.37529627463763, -99.15366546551034];
    mapInstance = L.map('map');

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(mapInstance);

    mapInstance.setView(coords, 15);

    L.marker(coords).addTo(mapInstance)
      .bindPopup('PanaderÃ­a La Desesperanza ğŸ')
      .openPopup();
  }

  function refrescarMapaSiOculto() {
    if (mapInstance) {
      setTimeout(() => {
        mapInstance.invalidateSize();
      }, 50);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    initMapa();
    refrescarMapaSiOculto();
  });

</script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>