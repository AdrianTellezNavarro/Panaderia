<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panader√≠a La Desesperanza üéÑ</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body {
      background: linear-gradient(135deg, #fff8f0, #ffe5d9);
      font-family: 'Segoe UI', sans-serif;
    }
    h1 {
      font-family: 'Georgia', serif;
      font-weight: bold;
      color: #b22222;
      text-shadow: 1px 1px #006400;
    }
    /* Login pro */
    #auth form {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    #auth .btn-primary {
      background-color: #b22222; border: none;
    }
    #auth .btn-primary:hover { background-color: #8b0000; }
    #auth .btn-secondary {
      background-color: #006400; border: none;
    }
    #auth .btn-secondary:hover { background-color: #228b22; }

    /* Panader√≠a forms */
    #panForm {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    }
    #panForm .btn-success { background-color: #006400; border: none; }
    #panForm .btn-success:hover { background-color: #228b22; }

    /* Carrito */
    #carritoSeccion { display: none; border: 2px solid #b22222; border-radius: 12px; }
    #carritoSeccion .card-header { background-color: #b22222; color: #fff; font-weight: bold; }
    #pagarCarritoBtn { background-color: #006400; border: none; }
    #pagarCarritoBtn:hover { background-color: #228b22; }

    /* Botones inferiores */
    #mostrarCarritoBtn { border-color: #b22222; color: #b22222; }
    #mostrarCarritoBtn:hover { background-color: #b22222; color: #fff; }
    #logoutBtn { border-color: #006400; color: #006400; }
    #logoutBtn:hover { background-color: #006400; color: #fff; }

    /* Map */
    #map {
      height: 400px; width: 100%;
      border: 3px solid #b22222;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      display: none;
    }

    /* Estado inicial */
    #panaderia, #logoutBtn { display: none; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="text-center">üéÑ Panader√≠a La Desesperanza üéÖ</h1>
    <p class="text-center">‚ú® Temporada navide√±a: disfruta pan de muerto y rosca de reyes üéÅ</p>

    <!-- Login / Registro -->
    <div id="auth" class="mb-4">
      <form id="loginForm" class="row g-3" autocomplete="off">
        <div class="col-md-3">
          <input type="text" id="nombre" class="form-control" placeholder="Nombre completo" required
            pattern="^[a-zA-Z√Å√â√ç√ì√ö√°√©√≠√≥√∫√±√ë\s]{2,50}$" title="Solo letras y espacios, m√≠nimo 2 caracteres">
        </div>
        <div class="col-md-3">
          <input type="text" id="username" class="form-control" placeholder="Nombre de usuario" required
            pattern="^[a-zA-Z0-9_.-]{3,30}$" title="3-30 caracteres, letras, n√∫meros y ._-">
        </div>
        <div class="col-md-3">
          <input type="email" id="correo" class="form-control" placeholder="Correo electr√≥nico" required>
        </div>
        <div class="col-md-3">
          <input type="password" id="contrase√±a" class="form-control" placeholder="Contrase√±a" required minlength="6" maxlength="50"
            title="M√≠nimo 6 caracteres">
        </div>
        <div class="col-12 d-flex gap-2 justify-content-end">
          <button type="submit" class="btn btn-primary">Iniciar sesi√≥n</button>
          <button type="button" id="registroBtn" class="btn btn-secondary">Registrarse</button>
        </div>
      </form>
    </div>

    <!-- Panader√≠a -->
    <div id="panaderia">
      <!-- Fondos del usuario -->
      <div class="alert alert-light border d-flex justify-content-between align-items-center">
        <div><strong>Fondos:</strong> <span id="fondosLabel">$0.00</span></div>
        <small class="text-muted">No puedes comprar si tus fondos son 0 o menores al total del carrito</small>
      </div>

      <form id="panForm" class="row g-3 mb-4">
        <input type="hidden" id="panId">
        <input type="hidden" id="imagenBase64">
        <div class="col-md-4">
          <input type="text" id="nombrePan" class="form-control" placeholder="Nombre del pan" required>
        </div>
        <div class="col-md-4">
          <input type="text" id="descripcion" class="form-control" placeholder="Descripci√≥n">
        </div>
        <div class="col-md-2">
          <input type="number" id="precio" class="form-control" placeholder="Precio" required min="0" step="0.01">
        </div>
        <div class="col-md-2">
          <input type="file" id="imagenFile" class="form-control" accept="image/*" required>
        </div>
        <div class="col-12 text-end">
          <button type="submit" class="btn btn-success">Guardar</button>
        </div>
      </form>

      <div id="galeria" class="row"></div>

      <!-- Carrito -->
      <div id="carritoSeccion" class="card mt-5">
        <div class="card-header">üõí Carrito</div>
        <div class="card-body">
          <table class="table table-bordered" id="tablaCarrito">
            <thead class="table-danger">
              <tr>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Cantidad</th>
                <th>Total</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <h4 class="text-end text-success fw-bold" id="totalCarrito">Total: $0.00</h4>
          <div class="text-end mt-3">
            <button id="pagarCarritoBtn" class="btn btn-success">üí∏ Pagar carrito</button>
          </div>
        </div>
      </div>

      <div class="text-end mt-3">
        <button id="mostrarCarritoBtn" class="btn btn-outline-primary">üõí Ver carrito</button>
        <button id="logoutBtn" class="btn btn-outline-danger">Cerrar sesi√≥n</button>
      </div>

      <div class="mt-4 text-center">
        <h4 class="text-primary">Vis√≠tanos</h4>
        <div id="map" style="margin-top:20px;"></div>
      </div>

      <!-- Historial del usuario -->
      <div class="mt-5">
        <h4>Mis compras</h4>
        <table class="table table-sm">
          <thead><tr><th># Venta</th><th>Fecha</th><th>Total</th><th></th></tr></thead>
          <tbody id="tablaHistorial"></tbody>
        </table>
      </div>

      <!-- Gr√°fico admin -->
      <div id="adminPanel" class="mt-5" style="display:none;">
        <h4>Ventas por d√≠a</h4>
        <div class="d-flex gap-2 mb-2">
          <input type="date" id="desde" class="form-control" style="max-width:200px;">
          <input type="date" id="hasta" class="form-control" style="max-width:200px;">
          <button id="btnGrafica" class="btn btn-outline-secondary">Actualizar</button>
        </div>
        <canvas id="ventasPorDia" height="120"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // NOTA: Mant√©n tu l√≥gica original. Solo sugerimos utilizar estos endpoints:
    // /login (username, contrase√±a), /registro, /usuarios/mis-fondos, /carrito, /carrito/checkout,
    // /ventas/mias, /ventas/:id/detalle, /admin/ventas/por-dia

    // Ejemplo de actualizaci√≥n de fondos (ll√°malo cuando muestres panader√≠a)
    async function actualizarFondos() {
      try {
        const res = await fetch('/usuarios/mis-fondos');
        if (!res.ok) return;
        const data = await res.json();
        document.getElementById('fondosLabel').textContent = '$' + Number(data.fondos || 0).toFixed(2);
      } catch {}
    }

    // Ejemplo de historial (ll√°malo despu√©s de login)
    async function cargarHistorial() {
      const tbody = document.getElementById('tablaHistorial');
      tbody.innerHTML = '';
      const res = await fetch('/ventas/mias');
      if (!res.ok) return;
      const ventas = await res.json();
      ventas.forEach(v => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${v.numero_venta}</td>
          <td>${new Date(v.fecha).toLocaleString()}</td>
          <td>$${Number(v.total).toFixed(2)}</td>
          <td><button class="btn btn-sm btn-outline-primary" onclick="verTicket(${v.id})">Ver ticket</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function verTicket(ventaId) {
      const detalleRes = await fetch('/ventas/' + ventaId + '/detalle');
      if (!detalleRes.ok) return alert('No se pudo cargar el ticket');
      const detalle = await detalleRes.json();
      const lineas = detalle.map(d => `- ${d.nombre} x${d.cantidad} @ $${Number(d.precio_unitario).toFixed(2)}`).join('\n');
      alert('Ticket:\n' + lineas);
    }

    // Gr√°fico admin (ll√°malo si detectas rol admin en tu l√≥gica)
    async function actualizarGrafica() {
      const desde = document.getElementById('desde').value;
      const hasta = document.getElementById('hasta').value;
      if (!desde || !hasta) return;
      const res = await fetch(`/admin/ventas/por-dia?desde=${desde}&hasta=${hasta}`);
      if (!res.ok) return;
      const data = await res.json();
      const ctx = document.getElementById('ventasPorDia').getContext('2d');
      if (window.chartVentas) window.chartVentas.destroy();
      window.chartVentas = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(r => r.dia),
          datasets: [{
            label: 'Ventas',
            data: data.map(r => r.monto),
            borderColor: '#b22222',
            backgroundColor: 'rgba(178,34,34,0.1)'
          }]
        }
      });
    }
    document.getElementById('btnGrafica')?.addEventListener('click', actualizarGrafica);
  </script>
</body>
</html>
